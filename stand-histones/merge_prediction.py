import sys
import pandas as pd
import numpy as np
from datetime import date


def replace_noCAsample(df_hist, df_pred):
    """Receives two dataframes and returns
    a merged df including EpiLaP prediction
    for samples in the CA db"""

    df_result = merge_dfs(df_hist, df_pred)
    #a = df_result[(df_result['Experimental_ID'].str.contains('---')) & (~df_result['Predicted_assay'].str.contains('----'))]
    # print(len(a)) #248
    df_result['Predicted_assay'] = np.where((df_result['Experimental_ID'] == '----') & \
        (df_result['Predicted_assay'] != '----'), '----', df_result['Predicted_assay'])
    df_result['Max_value'] = np.where((df_result['Experimental_ID'] == '----') & \
        (df_result['Predicted_assay'] != '----'), '----', df_result['Max_value'])
    
    return df_result


def merge_dfs(df_hist, df_pred):
    """Receives two dfs (metadata and 
    EpiLaP prediction - CA) and returns
    a merged df"""

    df_result = df_hist.merge(df_pred, how='left', left_on='SRX_GEO', right_on='Sample').fillna('----')

    return df_result.drop_duplicates()


def main():

    print('Starting script...')
    df_hist = pd.read_csv(sys.argv[1], sep='\t') #df histone generated by main_stand_dbs script
    df_pred = pd.read_csv(sys.argv[2]) # df with Predicted and Max_value prediction from EpiLaP
    df_result = replace_noCAsample(df_hist, df_pred)
    to_date = date.today()
    df_result.to_csv('Histones_allDBs_CA_pred_' + str(to_date) + '.tsv' , sep = '\t',index=False)
    print('File saved!')

if __name__ == "__main__":

    main()